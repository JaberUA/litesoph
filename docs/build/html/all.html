<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALL Notation &mdash; LITESOPH 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script>window.MathJax = {"tex": {"macros": {"br": "{\\mathbf r}", "bk": "{\\mathbf k}", "bG": "{\\mathbf G}"}}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="litesoph.visualization package" href="litesoph/litesoph.visualization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> LITESOPH
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">LITESOPH</a></li>
<li class="toctree-l1"><a class="reference internal" href="Simulations.html">Simulations of Photo-Physical Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorials/Tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Issues.html">Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="Developer_Guideline.html">Developer Guideline</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">ALL Notation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#table">table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mathematics">Mathematics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#references">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LITESOPH</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>ALL Notation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/all.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="all-notation">
<h1>ALL Notation<a class="headerlink" href="#all-notation" title="Permalink to this headline"></a></h1>
<section id="table">
<h2>table<a class="headerlink" href="#table" title="Permalink to this headline"></a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 63%" />
</colgroup>
<tbody>
<tr class="row-odd"><th class="stub"><p>First Name</p></th>
<td><p>Jaber</p></td>
<td><p>AA</p></td>
</tr>
<tr class="row-even"><th class="stub"><p>Last Name</p></th>
<td><p>Ahammad</p></td>
<td><p>BB</p></td>
</tr>
<tr class="row-odd"><th class="stub"><p>Age</p></th>
<td><p>26</p></td>
<td><p>65</p></td>
</tr>
</tbody>
</table>
</section>
<section id="mathematics">
<h2>Mathematics<a class="headerlink" href="#mathematics" title="Permalink to this headline"></a></h2>
<p>Time-dependent Schrodinger’s equation is :</p>
<div class="math notranslate nohighlight">
\[{\rm i} \hbar \frac{\partial \Psi }{\partial t} = \hat{H} (t) \mathbf{\Psi}\]</div>
<p>The starting point of time-propagation TDDFT is the all-electron time-dependent Kohn-Sham
(TDKS) equation,</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
i \frac{\partial \psi_n ({\bf r}, t)}{\partial t} = \hat {H} (t) \psi_n ({\bf r},t),
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\psi_n\)</span> is the Kohn-Sham wavefunction of electronic state n, and <span class="math notranslate nohighlight">\(\hat{H}\)</span> is the electronic
Hamiltonian.</p>
<div class="math notranslate nohighlight">
\[E_\text{DFT+U} = E_\text{DFT} +
\sum_a \frac{U_\text{eff}}{2}
\text{Tr}(\rho^a - \rho^a \rho^a),\]</div>
<div class="math notranslate nohighlight">
\[\tilde{\psi}^a(\mathbf{r}) =  \sum_i C_i^a \tilde{\phi}_i^a(\mathbf{r})\]</div>
<div class="math notranslate nohighlight">
\[\psi^a(\mathbf{r}) =  \sum_i C_i^a \phi_i^a(\mathbf{r}),\]</div>
<p>where <span class="math notranslate nohighlight">\(a\)</span> is C or O and <span class="math notranslate nohighlight">\(\phi_i\)</span> and <span class="math notranslate nohighlight">\(\tilde{\phi}_i\)</span></p>
<div class="math notranslate nohighlight">
\[n_{i+1}=\sum \alpha_i n_i \quad,\quad R_{i+1}=\sum \alpha_i R_i\]</div>
<p>The Stokes Raman intensity can be written as</p>
<div class="math notranslate nohighlight">
\[I(\omega) = I_0 \sum_\nu \frac{n_\nu+1}{\omega_\nu} \vert
\sum_{\alpha, \beta} u_{in}^\alpha R_{\alpha \beta}^\nu u_{out}^\beta
\vert^2 \delta(\omega-\omega_\nu)\]</div>
<p>where <span class="math notranslate nohighlight">\(\nu\)</span> denotes phonon modes and <span class="math notranslate nohighlight">\(\alpha\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span> denote polarisations
of the incoming and outgoing laser light.</p>
<p>The Raman tensor <span class="math notranslate nohighlight">\(R_{\alpha \beta}^\nu\)</span> has six terms and is given by
Ref. <a href="#id3"><span class="problematic" id="id1">[#Taghizadeh2020]_</span></a> Eq. (10)</p>
<div class="math notranslate nohighlight">
\[\begin{split}R_{\alpha \beta}^\nu \equiv \sum_{ijmn \mathbf{k}} [
\frac{p_{ij}^\alpha (g_{jm}^\nu \delta_{in} - g_{ni}^\nu \delta_{jm})p_{mn}^\beta}{(\hbar \omega_{in}-\varepsilon_{ji})(\hbar \omega_{out}-\varepsilon_{mn})} +
\frac{p_{ij}^\alpha (p_{jm}^\beta \delta_{in} - p_{ni}^\beta \delta_{jm})g_{mn}^\nu}{(\hbar \omega_{in}-\varepsilon_{ji})(\hbar \omega_{\nu}-\varepsilon_{mn})} + \\
\frac{p_{ij}^\beta (g_{jm}^\nu \delta_{in} - g_{ni}^\nu \delta_{jm})p_{mn}^\alpha}{(-\hbar \omega_{out}-\varepsilon_{ji})(-\hbar \omega_{in}-\varepsilon_{mn})} +
\frac{p_{ij}^\beta (p_{jm}^\alpha \delta_{in} - p_{ni}^\alpha \delta_{jm})g_{mn}^\nu}{(-\hbar \omega_{out}-\varepsilon_{ji})(\hbar \omega_{\nu}-\varepsilon_{mn})} + \\
\frac{g_{ij}^\nu (p_{jm}^\alpha \delta_{in} - p_{ni}^\alpha \delta_{jm})p_{mn}^\beta}{(-\hbar \omega_{\nu}-\varepsilon_{ji})(\hbar \omega_{out}-\varepsilon_{mn})} +
\frac{g_{ij}^\nu (p_{jm}^\beta \delta_{in} - p_{ni}^\beta \delta_{jm})p_{mn}^\alpha}{(-\hbar \omega_{\nu}-\varepsilon_{ji})(-\hbar \omega_{in}-\varepsilon_{mn})}
] f_i(1-f_j)f_n(1-f_m)\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\ddot{\bf R}(t) &amp;= \frac{\mathbf{F}(\mathbf{R}(t), n (t))}{M} \\
\mathbf{R} (t + \Delta t/2)
&amp;= \mathbf{R}(t) + \dot{\bf R} (t) \frac{\Delta t}{2} + \frac{1}{2}
\ddot{\bf R}(t) \left(\frac{\Delta t}{2}\right)^2 \\
\dot{\bf R}(t+ \Delta t/4) &amp;= \dot{\bf R}(t) + \frac{1}{2} \ddot{\bf R}(t) \frac{\Delta t}{2}
\end{align}\end{split}\]</div>
<p>Notice that an energy integrating of the LDOS multiplied by a Fermi
distribution gives the electron density</p>
<div class="math notranslate nohighlight">
\[\begin{split}\int\!\mathrm{d}\varepsilon\ n_F(\varepsilon) \rho(r, \varepsilon) = n(r) \\
\mathrm{d}y/\mathrm{d}x\end{split}\]</div>
<p>The density of states is defined by</p>
<div class="math notranslate nohighlight">
\[\rho(\varepsilon) = \sum_n \langle\psi_n|\psi_n\rangle
\delta(\varepsilon-\varepsilon_n),\]</div>
<p>where <span class="math notranslate nohighlight">\(\varepsilon_n\)</span> is the eigenvalue of the eigenstate <span class="math notranslate nohighlight">\(|\psi_n\rangle\)</span>.</p>
<p>From this, the following matrix equation can be derived for the
LCAO wave function coefficients:</p>
<div class="math notranslate nohighlight">
\[{\rm i}\mathbf{S} \frac{{\rm d}\mathbf{C}(t)}{{\rm d}t} = \mathbf{H}(t) \mathbf{C}(t).\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\ddot{\underline{\mathbf{r}}} &amp;= \frac{d{^2}\underline{\mathbf{r}}}{dt^2}\\
                              &amp;= 0
\end{align}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\ddot{\underline{\mathbf{r}}} &amp;= \frac{d{^2}\underline{\mathbf{r}}}{dt^2}\\
                            &amp;= 0
\end{align}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{equation} \label{eq1}
\begin{split}
A &amp; = \frac{\pi r^2}{2} \\
&amp; = \frac{1}{2} \pi r^2
\end{split}
\end{equation}\end{split}\]</div>
<p>“””</p>
<p>#               ##            =============
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#               ##                  ##
#===========</p>
<p>“””</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While this feature should be working, it is mostly untested in
real applications.  Most codes do not support multiple U
corrections to the same element, so finding comparisons may be
difficult.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Check what ever you write.</p>
</div>
<p>see <a class="reference download internal" download="" href="_downloads/8336d444784b8833fa2d8a0cf4066e9d/lumache.py"><code class="xref download docutils literal notranslate"><span class="pre">../src/lumache.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;This module defines an ASE-calculator interface to GPAW.</span>

<span class="sd">The central object that glues everything together.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">ase.calculators.calculator</span> <span class="kn">import</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">kpts2ndarray</span>
<span class="kn">from</span> <span class="nn">ase.dft.bandgap</span> <span class="kn">import</span> <span class="n">bandgap</span>
<span class="kn">from</span> <span class="nn">ase.units</span> <span class="kn">import</span> <span class="n">Bohr</span><span class="p">,</span> <span class="n">Ha</span>
<span class="kn">from</span> <span class="nn">ase.utils</span> <span class="kn">import</span> <span class="n">plural</span>
<span class="kn">from</span> <span class="nn">ase.utils.timing</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="kn">import</span> <span class="nn">gpaw</span>
<span class="kn">import</span> <span class="nn">gpaw.mpi</span> <span class="k">as</span> <span class="nn">mpi</span>
<span class="kn">from</span> <span class="nn">gpaw.band_descriptor</span> <span class="kn">import</span> <span class="n">BandDescriptor</span>
<span class="kn">from</span> <span class="nn">gpaw.convergence_criteria</span> <span class="kn">import</span> <span class="n">dict2criterion</span>
<span class="kn">from</span> <span class="nn">gpaw.density</span> <span class="kn">import</span> <span class="n">RealSpaceDensity</span>
<span class="kn">from</span> <span class="nn">gpaw.dos</span> <span class="kn">import</span> <span class="n">DOSCalculator</span>
<span class="kn">from</span> <span class="nn">gpaw.eigensolvers</span> <span class="kn">import</span> <span class="n">get_eigensolver</span>
<span class="kn">from</span> <span class="nn">gpaw.external</span> <span class="kn">import</span> <span class="n">PointChargePotential</span>
<span class="kn">from</span> <span class="nn">gpaw.forces</span> <span class="kn">import</span> <span class="n">calculate_forces</span>
<span class="kn">from</span> <span class="nn">gpaw.grid_descriptor</span> <span class="kn">import</span> <span class="n">GridDescriptor</span>
<span class="kn">from</span> <span class="nn">gpaw.hamiltonian</span> <span class="kn">import</span> <span class="n">RealSpaceHamiltonian</span>
<span class="kn">from</span> <span class="nn">gpaw.hybrids</span> <span class="kn">import</span> <span class="n">HybridXC</span>
<span class="kn">from</span> <span class="nn">gpaw.io</span> <span class="kn">import</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">Writer</span>
<span class="kn">from</span> <span class="nn">gpaw.io.logger</span> <span class="kn">import</span> <span class="n">GPAWLogger</span>
<span class="kn">from</span> <span class="nn">gpaw.jellium</span> <span class="kn">import</span> <span class="n">create_background_charge</span>
<span class="kn">from</span> <span class="nn">gpaw.kohnsham_layouts</span> <span class="kn">import</span> <span class="n">get_KohnSham_layouts</span>
<span class="kn">from</span> <span class="nn">gpaw.kpt_descriptor</span> <span class="kn">import</span> <span class="n">KPointDescriptor</span>
<span class="kn">from</span> <span class="nn">gpaw.kpt_refine</span> <span class="kn">import</span> <span class="n">create_kpoint_descriptor_with_refinement</span>
<span class="kn">from</span> <span class="nn">gpaw.matrix</span> <span class="kn">import</span> <span class="n">suggest_blocking</span>
<span class="kn">from</span> <span class="nn">gpaw.occupations</span> <span class="kn">import</span> <span class="n">ParallelLayout</span><span class="p">,</span> <span class="n">create_occ_calc</span>
<span class="kn">from</span> <span class="nn">gpaw.output</span> <span class="kn">import</span> <span class="p">(</span><span class="n">print_cell</span><span class="p">,</span> <span class="n">print_parallelization_details</span><span class="p">,</span>
                         <span class="n">print_positions</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gpaw.pw.density</span> <span class="kn">import</span> <span class="n">ReciprocalSpaceDensity</span>
<span class="kn">from</span> <span class="nn">gpaw.pw.hamiltonian</span> <span class="kn">import</span> <span class="n">ReciprocalSpaceHamiltonian</span>
<span class="kn">from</span> <span class="nn">gpaw.scf</span> <span class="kn">import</span> <span class="n">SCFLoop</span>
<span class="kn">from</span> <span class="nn">gpaw.setup</span> <span class="kn">import</span> <span class="n">Setups</span>
<span class="kn">from</span> <span class="nn">gpaw.stress</span> <span class="kn">import</span> <span class="n">calculate_stress</span>
<span class="kn">from</span> <span class="nn">gpaw.symmetry</span> <span class="kn">import</span> <span class="n">Symmetry</span>
<span class="kn">from</span> <span class="nn">gpaw.typing</span> <span class="kn">import</span> <span class="n">Array1D</span>
<span class="kn">from</span> <span class="nn">gpaw.utilities</span> <span class="kn">import</span> <span class="n">check_atoms_too_close</span><span class="p">,</span> <span class="n">compiled_with_sl</span>
<span class="kn">from</span> <span class="nn">gpaw.utilities.gpts</span> <span class="kn">import</span> <span class="n">get_number_of_grid_points</span>
<span class="kn">from</span> <span class="nn">gpaw.utilities.grid</span> <span class="kn">import</span> <span class="n">GridRedistributor</span>
<span class="kn">from</span> <span class="nn">gpaw.utilities.memory</span> <span class="kn">import</span> <span class="n">MemNode</span><span class="p">,</span> <span class="n">maxrss</span>
<span class="kn">from</span> <span class="nn">gpaw.utilities.partition</span> <span class="kn">import</span> <span class="n">AtomPartition</span>
<span class="kn">from</span> <span class="nn">gpaw.wavefunctions.mode</span> <span class="kn">import</span> <span class="n">create_wave_function_mode</span>
<span class="kn">from</span> <span class="nn">gpaw.xc</span> <span class="kn">import</span> <span class="n">XC</span>
<span class="kn">from</span> <span class="nn">gpaw.xc.kernel</span> <span class="kn">import</span> <span class="n">XCKernel</span>
<span class="kn">from</span> <span class="nn">gpaw.xc.sic</span> <span class="kn">import</span> <span class="n">SIC</span>


<span class="k">class</span> <span class="nc">GPAW</span><span class="p">(</span><span class="n">Calculator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the ASE-calculator frontend for doing a GPAW calculation.&quot;&quot;&quot;</span>

    <span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;free_energy&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;forces&#39;</span><span class="p">,</span> <span class="s1">&#39;stress&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="s1">&#39;magmom&#39;</span><span class="p">,</span> <span class="s1">&#39;magmoms&#39;</span><span class="p">]</span>

    <span class="n">default_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;fd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xc&#39;</span><span class="p">:</span> <span class="s1">&#39;LDA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;occupations&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;poissonsolver&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Angstrom</span>
        <span class="s1">&#39;gpts&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;kpts&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)],</span>
        <span class="s1">&#39;nbands&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;charge&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;setups&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;spinpol&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;mixer&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;eigensolver&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;background_charge&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;experimental&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reuse_wfs_method&#39;</span><span class="p">:</span> <span class="s1">&#39;paw&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;niter_fixdensity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;magmoms&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;soc&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;kpt_refine&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="s1">&#39;external&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;hund&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">333</span><span class="p">,</span>
        <span class="s1">&#39;symmetry&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;point_group&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;time_reversal&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;symmorphic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;tolerance&#39;</span><span class="p">:</span> <span class="mf">1e-7</span><span class="p">,</span>
                     <span class="s1">&#39;do_not_symmetrize_the_density&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>  <span class="c1"># deprecated</span>
        <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span>  <span class="c1"># eV / electron</span>
                        <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="mf">1.0e-4</span><span class="p">,</span>  <span class="c1"># electrons / electron</span>
                        <span class="s1">&#39;eigenstates&#39;</span><span class="p">:</span> <span class="mf">4.0e-8</span><span class="p">,</span>  <span class="c1"># eV^2 / electron</span>
                        <span class="s1">&#39;bands&#39;</span><span class="p">:</span> <span class="s1">&#39;occupied&#39;</span><span class="p">},</span>
        <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;fixdensity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># deprecated</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># deprecated</span>

    <span class="n">default_parallel</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;kpt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;band&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;kdb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stridebands&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;augment_grids&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;sl_auto&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;sl_default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;sl_diagonalize&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;sl_inverse_cholesky&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;sl_lcao&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;sl_lrtddft&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;use_elpa&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;elpasolver&#39;</span><span class="p">:</span> <span class="s1">&#39;2stage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;buffer_size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">restart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">timer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">communicator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">txt</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                 <span class="n">parallel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">txt</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">restart</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_parallel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parallel</span><span class="p">:</span>
                    <span class="n">allowed</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_parallel</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected keyword &quot;</span><span class="si">{}</span><span class="s1">&quot; in &quot;parallel&quot; &#39;</span>
                                    <span class="s1">&#39;dictionary.  Must be one of: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">allowed</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># XXX store this in some better way.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># XXX move to self.scf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">communicator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">world</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="s1">&#39;new_communicator&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">new_communicator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">GPAWLogger</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">txt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Calculator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fixed_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                      <span class="n">update_fermi_level</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">communicator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">txt</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                      <span class="n">parallel</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;GPAW&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new calculator and do SCF calculation with fixed density.</span>

<span class="sd">        Returns a new GPAW object fully converged.</span>

<span class="sd">        Useful for band-structure calculations.  Given a ground-state</span>
<span class="sd">        calculation, ``gs_calc``, one can do::</span>

<span class="sd">            bs_calc = gs_calc.fixed_density(kpts=&lt;path&gt;,</span>
<span class="sd">                                            symmetry=&#39;off&#39;)</span>
<span class="sd">            bs = bs_calc.get_band_structure()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">update_fermi_level</span>  <span class="c1"># for now ...</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;nbands&#39;</span><span class="p">,</span> <span class="s1">&#39;occupations&#39;</span><span class="p">,</span> <span class="s1">&#39;poissonsolver&#39;</span><span class="p">,</span> <span class="s1">&#39;kpts&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;eigensolver&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="s1">&#39;basis&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot change </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1"> in &#39;</span>
                                <span class="s1">&#39;fixed_density calculation!&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Backwards compatibility</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;gpts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">N_c</span>

        <span class="n">calc</span> <span class="o">=</span> <span class="n">GPAW</span><span class="p">(</span><span class="n">communicator</span><span class="o">=</span><span class="n">communicator</span><span class="p">,</span>
                    <span class="n">txt</span><span class="o">=</span><span class="n">txt</span><span class="p">,</span>
                    <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">initialize_from_other_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                                                   <span class="n">calc</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kptband_comm</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;GLLB&#39;</span><span class="p">:</span>
            <span class="n">new_response</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">response</span>
            <span class="n">old_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">response</span>
            <span class="n">new_response</span><span class="o">.</span><span class="n">initialize_from_other_response</span><span class="p">(</span><span class="n">old_response</span><span class="p">)</span>
            <span class="n">new_response</span><span class="o">.</span><span class="n">fix_potential</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">system_changes</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">return</span> <span class="n">calc</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Write timings and close reader if necessary.</span>
        <span class="c1"># If we crashed in the constructor (e.g. a bad keyword), we may not</span>
        <span class="c1"># have the normally expected attributes:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;timer&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;reader&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write calculator object to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename</span>
<span class="sd">            File to be written</span>
<span class="sd">        mode</span>
<span class="sd">            Write mode. Use ``mode=&#39;all&#39;``</span>
<span class="sd">            to include wave functions in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> (mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">!r}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ase.io.trajectory</span> <span class="kn">import</span> <span class="n">write_atoms</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gpaw_version</span><span class="o">=</span><span class="n">gpaw</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="n">Ha</span><span class="p">,</span> <span class="n">bohr</span><span class="o">=</span><span class="n">Bohr</span><span class="p">)</span>

        <span class="n">write_atoms</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">todict</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">))</span>
        <span class="c1"># self.occupations.write(writer.child(&#39;occupations&#39;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;scf&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="s1">&#39;wave_functions&#39;</span><span class="p">),</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">writer</span>

    <span class="k">def</span> <span class="nf">_set_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="n">check_atoms_too_close</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="c1"># GPAW works in terms of the scaled positions.  We want to</span>
        <span class="c1"># extract the scaled positions in only one place, and that is</span>
        <span class="c1"># here.  No other place may recalculate them, or we might end up</span>
        <span class="c1"># with rounding errors and inconsistencies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">()</span> <span class="o">%</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ase.io.trajectory</span> <span class="kn">import</span> <span class="n">read_atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Reading from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">reader</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Can&#39;&#39;t read new GPW-files&#39;</span>

        <span class="n">atoms</span> <span class="o">=</span> <span class="n">read_atoms</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Read </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">))))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Reading input parameters:&#39;</span><span class="p">)</span>
        <span class="c1"># XXX param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_parameters</span><span class="p">()</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;fixdensity&#39;</span><span class="p">}:</span>
                <span class="k">continue</span>  <span class="c1"># old gpw-files may have these</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">reading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

        <span class="c1"># We need to do this in a better way:  XXX</span>
        <span class="kn">from</span> <span class="nn">gpaw.utilities.partition</span> <span class="kn">import</span> <span class="n">AtomPartition</span>
        <span class="n">atom_partition</span> <span class="o">=</span> <span class="n">AtomPartition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">atom_partition</span> <span class="o">=</span> <span class="n">atom_partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">atom_partition</span> <span class="o">=</span> <span class="n">atom_partition</span>
        <span class="n">rank_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">get_ranks_from_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">)</span>
        <span class="n">new_atom_partition</span> <span class="o">=</span> <span class="n">AtomPartition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">rank_a</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">]:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">set_positions_without_ruining_everything</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">,</span>
                                                         <span class="n">new_atom_partition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_atom_partition</span> <span class="o">!=</span> <span class="n">atom_partition</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">:</span>
                <span class="n">kpt</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">kpt</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">redist</span><span class="p">(</span><span class="n">new_atom_partition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">atom_partition</span> <span class="o">=</span> <span class="n">new_atom_partition</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reader</span>

    <span class="k">def</span> <span class="nf">check_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
        <span class="n">system_changes</span> <span class="o">=</span> <span class="n">Calculator</span><span class="o">.</span><span class="n">check_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;positions&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">system_changes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">vext</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">vext</span><span class="o">.</span><span class="n">vext_g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># QMMM atoms have moved:</span>
                        <span class="n">system_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system_changes</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
                  <span class="n">system_changes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">icalculate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">icalculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
                   <span class="n">system_changes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Calculate things.&quot;&quot;&quot;</span>

        <span class="n">Calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>

        <span class="k">if</span> <span class="n">system_changes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;System changes:&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_changes</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">system_changes</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]:</span>
                <span class="c1"># Only positions have changed:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Drastic changes:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">positions_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">positions_set</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="k">yield</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">print_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;SCF-cycle&#39;</span><span class="p">):</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">irun</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_observers</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Converged after </span><span class="si">{}</span><span class="s1"> iterations.</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">niter</span><span class="p">))</span>

            <span class="n">e_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">e_total_free</span>
            <span class="n">e_extrapolated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">e_total_extrapolated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_extrapolated</span> <span class="o">*</span> <span class="n">Ha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;free_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_free</span> <span class="o">*</span> <span class="n">Ha</span>

            <span class="n">dipole_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">calculate_dipole_moment</span><span class="p">()</span> <span class="o">*</span> <span class="n">Bohr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Dipole moment: (</span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">) |e|*Ang</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">dipole_v</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;dipole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dipole_v</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">collinear</span><span class="p">:</span>
                <span class="n">totmom_v</span><span class="p">,</span> <span class="n">magmom_av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">estimate_magnetic_moments</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Total magnetic moment: (</span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">)&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">totmom_v</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Local magnetic moments:&#39;</span><span class="p">)</span>
                <span class="n">symbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_chemical_symbols</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">mom_v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">magmom_av</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:2}</span><span class="s1"> (</span><span class="si">{:9.6f}</span><span class="s1">, </span><span class="si">{:9.6f}</span><span class="s1">, </span><span class="si">{:9.6f}</span><span class="s1">)&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">symbols</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="o">*</span><span class="n">mom_v</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;magmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totmom_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;magmoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magmom_av</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;magmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;magmoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">call_observers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;forces&#39;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Forces&#39;</span><span class="p">):</span>
                <span class="n">F_av</span> <span class="o">=</span> <span class="n">calculate_forces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_av</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ha</span> <span class="o">/</span> <span class="n">Bohr</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;stress&#39;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Stress&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stress</span> <span class="o">=</span> <span class="n">calculate_stress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                    <span class="c1"># Our ASE Calculator base class will raise</span>
                    <span class="c1"># PropertyNotImplementedError for us.</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ha</span> <span class="o">/</span> <span class="n">Bohr</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;magmom&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bandgap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span>
                        <span class="n">efermi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_level</span> <span class="o">*</span> <span class="n">Ha</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change parameters for calculator.</span>

<span class="sd">        Examples::</span>

<span class="sd">            calc.set(xc=&#39;PBE&#39;)</span>
<span class="sd">            calc.set(nbands=20, kpts=(4, 1, 1))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Verify that keys are consistent with default ones.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;txt&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unknown GPAW parameter: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;experimental&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># For values that are dictionaries, verify subkeys, too.</span>
                <span class="n">default_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">subkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_dict</span><span class="p">:</span>
                        <span class="n">allowed</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">default_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unknown subkeyword &quot;</span><span class="si">{}</span><span class="s1">&quot; of keyword &#39;</span>
                                        <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;.  Must be one of: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">allowed</span><span class="p">))</span>

        <span class="c1"># We need to handle txt early in order to get logging up and running:</span>
        <span class="k">if</span> <span class="s1">&#39;txt&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;txt&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;idiotproof&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;idiotproof&#39;</span><span class="p">]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Ignoring deprecated keyword &quot;idiotproof&quot;&#39;</span><span class="p">)</span>

        <span class="n">changed_parameters</span> <span class="o">=</span> <span class="n">Calculator</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;setups&#39;</span><span class="p">,</span> <span class="s1">&#39;basis&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">changed_parameters</span><span class="p">:</span>
                <span class="n">dct</span> <span class="o">=</span> <span class="n">changed_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
                    <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Please use </span><span class="si">{key}</span><span class="s1">=</span><span class="si">{dct}</span><span class="s1">&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dct</span><span class="o">=</span><span class="n">dct</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Input parameters:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">changed_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">changed_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;eigensolver&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">set_eigensolver</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mixer&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;hund&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;eigensolver&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;fixdensity&#39;</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># Check nested arguments</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;experimental&#39;</span><span class="p">]:</span>
                <span class="n">changed_parameters2</span> <span class="o">=</span> <span class="n">changed_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">changed_parameters2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kpt_refine&#39;</span><span class="p">,</span> <span class="s1">&#39;magmoms&#39;</span><span class="p">,</span> <span class="s1">&#39;soc&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">key2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reuse_wfs_method&#39;</span><span class="p">,</span> <span class="s1">&#39;niter_fixdensity&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unknown keyword argument:&#39;</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># More drastic changes:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">set_orthonormalized</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xc&#39;</span><span class="p">,</span> <span class="s1">&#39;poissonsolver&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;occupations&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;background_charge&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">,</span> <span class="s1">&#39;nbands&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetry&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;gpts&#39;</span><span class="p">,</span> <span class="s1">&#39;setups&#39;</span><span class="p">,</span> <span class="s1">&#39;spinpol&#39;</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unknown keyword argument: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the positions of the atoms.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Initializing position-dependent things.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">mpi</span><span class="o">.</span><span class="n">synchronize_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>

        <span class="n">rank_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">get_ranks_from_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">)</span>
        <span class="n">atom_partition</span> <span class="o">=</span> <span class="n">AtomPartition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">rank_a</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">,</span> <span class="n">atom_partition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">,</span> <span class="n">atom_partition</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">,</span> <span class="n">atom_partition</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the positions of the atoms and initialize wave functions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_positions</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">nlcao</span><span class="p">,</span> <span class="n">nrand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nlcao</span> <span class="o">+</span> <span class="n">nrand</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Creating initial wave functions:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nlcao</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">plural</span><span class="p">(</span><span class="n">nlcao</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">),</span> <span class="s1">&#39;from LCAO basis set&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrand</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">plural</span><span class="p">(</span><span class="n">nrand</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">),</span> <span class="s1">&#39;from random numbers&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">eigensolver</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">occ_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">occupations</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">occ_name</span> <span class="o">==</span> <span class="s1">&#39;mom&#39;</span><span class="p">:</span>
            <span class="c1"># Initialize MOM reference orbitals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">occupations</span><span class="o">.</span><span class="n">initialize_reference_orbitals</span><span class="p">()</span>
        <span class="n">print_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">magmom_av</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reading</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inexpensive initialization.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Initialize ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">cell_cv</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span> <span class="o">/</span> <span class="n">Bohr</span>
        <span class="n">number_of_lattice_vectors</span> <span class="o">=</span> <span class="n">cell_cv</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">number_of_lattice_vectors</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;GPAW requires 3 lattice vectors.  Your system has </span><span class="si">{}</span><span class="s1">.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_lattice_vectors</span><span class="p">))</span>

        <span class="n">pbc_c</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_pbc</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbc_c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">magmom_a</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_initial_magnetic_moments</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;magmoms&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">magmom_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">experimental</span><span class="p">[</span><span class="s1">&#39;magmoms&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">collinear</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">magmom_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">magmom_av</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">magmom_a</span>
            <span class="n">collinear</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mpi</span><span class="o">.</span><span class="n">synchronize_atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>

        <span class="c1"># Generate new xc functional only when it is reset by set</span>
        <span class="c1"># XXX sounds like this should use the _changed_keywords dictionary.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">XCKernel</span><span class="p">)):</span>
                <span class="n">xc</span> <span class="o">=</span> <span class="n">XC</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span> <span class="n">collinear</span><span class="o">=</span><span class="n">collinear</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xc</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">xc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">fixdensity</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The fixdensity keyword has been deprecated. &#39;</span>
                <span class="s1">&#39;Please use the GPAW.fixed_density() method instead.&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">mode</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">mode</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">create_wave_function_mode</span><span class="p">(</span><span class="o">**</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">complex</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use mode=</span><span class="si">{}</span><span class="s1">(..., force_complex_dtype=True) &#39;</span>
                          <span class="s1">&#39;instead of dtype=complex&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="n">mode</span><span class="o">.</span><span class="n">force_complex_dtype</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">del</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
            <span class="n">par</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="k">if</span> <span class="n">xc</span><span class="o">.</span><span class="n">orbital_dependent</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;LCAO mode does not support &#39;</span>
                             <span class="s1">&#39;orbital-dependent XC functionals.&#39;</span><span class="p">)</span>

        <span class="n">realspace</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;pw&#39;</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">!=</span> <span class="s1">&#39;fft&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_setups</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">xc</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">realspace</span><span class="p">:</span>
            <span class="n">pbc_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="n">magnetic</span> <span class="o">=</span> <span class="n">magmom_av</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">hund</span><span class="p">:</span>
            <span class="n">spinpol</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">magnetic</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">natoms</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">setup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">):</span>
                <span class="n">magmom_av</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">get_hunds_rule_moment</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">collinear</span><span class="p">:</span>
            <span class="n">spinpol</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">spinpol</span>
            <span class="k">if</span> <span class="n">spinpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spinpol</span> <span class="o">=</span> <span class="n">magnetic</span>
            <span class="k">elif</span> <span class="n">magnetic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spinpol</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Non-zero initial magnetic moment for a &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;spin-paired calculation!&#39;</span><span class="p">)</span>
            <span class="n">nspins</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">spinpol</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">spinpol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Spin-polarized calculation.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Magnetic moment: </span><span class="si">{:.6f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magmom_av</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Spin-paired calculation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nspins</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Non-collinear calculation.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Magnetic moment: (</span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">, </span><span class="si">{:.6f}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">magmom_av</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_symmetry</span><span class="p">(</span><span class="n">magmom_av</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">reading</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">gpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;You can&#39;t use both &quot;gpts&quot; and &quot;h&quot;!&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">N_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">gpts</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">/=</span> <span class="n">Bohr</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reading</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">N_c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pbc_c</span> <span class="o">+</span> <span class="n">shape</span>
            <span class="k">elif</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">N_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">N_c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">N_c</span> <span class="o">=</span> <span class="n">get_number_of_grid_points</span><span class="p">(</span><span class="n">cell_cv</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">realspace</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">set_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">collinear</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="o">.</span><span class="n">op_scc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Can&#39;&#39;t use symmetries with non-collinear &#39;</span>
                             <span class="s1">&#39;calculations&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">background_charge</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">create_background_charge</span><span class="p">(</span><span class="o">**</span><span class="n">par</span><span class="o">.</span><span class="n">background_charge</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">background_charge</span>

        <span class="n">nao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">nao</span>
        <span class="n">nvalence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">nvalence</span> <span class="o">-</span> <span class="n">par</span><span class="o">.</span><span class="n">charge</span>
        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">background_charge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nvalence</span> <span class="o">+=</span> <span class="n">background</span><span class="o">.</span><span class="n">charge</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">magmom_av</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">nbands</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">nbands</span>

        <span class="n">orbital_free</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">orbital_free</span> <span class="k">for</span> <span class="n">setup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orbital_free</span><span class="p">:</span>
            <span class="n">nbands</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nbands</span> <span class="o">==</span> <span class="s1">&#39;nao&#39;</span><span class="p">:</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="n">nao</span>
            <span class="k">elif</span> <span class="n">nbands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
                <span class="n">basebands</span> <span class="o">=</span> <span class="p">(</span><span class="n">nvalence</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nbands</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">basebands</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Integer expected: Only use a string &#39;</span>
                                 <span class="s1">&#39;if giving a percentage of occupied bands&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nbands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Number of bound partial waves:</span>
            <span class="n">nbandsmax</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">get_default_nbands</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">setup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">)</span>
            <span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mf">1.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvalence</span> <span class="o">+</span> <span class="n">M</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="n">nbands</span> <span class="o">&gt;</span> <span class="n">nbandsmax</span><span class="p">:</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="n">nbandsmax</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span> <span class="ow">and</span> <span class="n">nbands</span> <span class="o">&gt;</span> <span class="n">nao</span><span class="p">:</span>
                <span class="n">nbands</span> <span class="o">=</span> <span class="n">nao</span>
        <span class="k">elif</span> <span class="n">nbands</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbands</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nvalence</span> <span class="o">+</span> <span class="n">M</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">nbands</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">nbands</span> <span class="o">&gt;</span> <span class="n">nao</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too many bands for LCAO calculation: &#39;</span>
                             <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> bands and only </span><span class="si">%d</span><span class="s1"> atomic orbitals!&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">nao</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">nvalence</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Charge </span><span class="si">%f</span><span class="s1"> is not possible - not enough valence electrons&#39;</span> <span class="o">%</span>
                <span class="n">par</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nvalence</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nbands</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">orbital_free</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too few bands!  Electrons: </span><span class="si">%f</span><span class="s1">, bands: </span><span class="si">%d</span><span class="s1">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">nvalence</span><span class="p">,</span> <span class="n">nbands</span><span class="p">))</span>

        <span class="c1"># Gather convergence criteria for SCF loop.</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span><span class="p">[</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># keep order</span>
        <span class="n">criteria</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
        <span class="n">custom</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">del</span> <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="s1">&#39;todict&#39;</span><span class="p">):</span>
                <span class="c1"># &#39;Copy&#39; so no two calculators share an instance.</span>
                <span class="n">criteria</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2criterion</span><span class="p">(</span><span class="n">criterion</span><span class="o">.</span><span class="n">todict</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">criteria</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2criterion</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">criterion</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">custom</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">custom</span> <span class="o">=</span> <span class="p">[</span><span class="n">custom</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="n">custom</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># from .gpw file</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Custom convergence criterion &quot;</span><span class="si">{:s}</span><span class="s1">&quot; encountered, &#39;</span>
                       <span class="s1">&#39;which GPAW does not know how to load. This &#39;</span>
                       <span class="s1">&#39;criterion is NOT enabled; you may want to manually&#39;</span>
                       <span class="s1">&#39; set it.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">criterion</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">criteria</span><span class="p">[</span><span class="n">criterion</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">criterion</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Custom convergence criterion </span><span class="si">{:s}</span><span class="s1"> encountered. &#39;</span>
                   <span class="s1">&#39;Please be sure that each calculator is fed a &#39;</span>
                   <span class="s1">&#39;unique instance of this criterion. &#39;</span>
                   <span class="s1">&#39;Note that if you save the calculator instance to &#39;</span>
                   <span class="s1">&#39;a .gpw file you may not be able to re-open it. &#39;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">criterion</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_scf</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">collinear</span><span class="p">:</span>
            <span class="n">nbands</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_wave_functions</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">realspace</span><span class="p">,</span>
                                       <span class="n">nspins</span><span class="p">,</span> <span class="n">collinear</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">nao</span><span class="p">,</span>
                                       <span class="n">nvalence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">,</span>
                                       <span class="n">cell_cv</span><span class="p">,</span> <span class="n">pbc_c</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span>
                                       <span class="n">xc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">set_setups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">)</span>

        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_occupations</span><span class="p">(</span><span class="n">cell_cv</span><span class="p">,</span> <span class="n">magmom_av</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                                      <span class="n">orbital_free</span><span class="p">,</span> <span class="n">nvalence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">occupations</span> <span class="o">=</span> <span class="n">occ</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">eigensolver</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_eigensolver</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reading</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">par</span><span class="o">.</span><span class="n">fixdensity</span><span class="p">,</span> <span class="s1">&#39;No density to fix!&#39;</span>

        <span class="n">olddens</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">parsize_c</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">parsize_c</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="c1"># Domain decomposition has changed, so we need to</span>
            <span class="c1"># reinitialize density and hamiltonian:</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">fixdensity</span><span class="p">:</span>
                <span class="n">olddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_density</span><span class="p">(</span><span class="n">realspace</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="c1"># XXXXXXXXXX if setups change, then setups.core_charge may change.</span>
        <span class="c1"># But that parameter was supplied in Density constructor!</span>
        <span class="c1"># This surely is a bug!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span>
                                <span class="n">magmom_av</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">hund</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">set_mixer</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">mixer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dummy&#39;</span> <span class="ow">or</span> <span class="n">par</span><span class="o">.</span><span class="n">fixdensity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;No density mixing</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">mixer</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">fixdensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">if</span> <span class="n">olddens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">initialize_from_other_density</span><span class="p">(</span><span class="n">olddens</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kptband_comm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_hamiltonian</span><span class="p">(</span><span class="n">realspace</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">xc</span><span class="p">)</span>

        <span class="n">xc</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">xc</span><span class="o">.</span><span class="n">get_description</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;XC parameters: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())))</span>

        <span class="k">if</span> <span class="n">xc</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;GLLB&#39;</span> <span class="ow">and</span> <span class="n">olddens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xc</span><span class="o">.</span><span class="n">heeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeelp</span><span class="p">(</span><span class="n">olddens</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_memory_estimate</span><span class="p">(</span><span class="n">maxdepth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">print_parallelization_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Number of atoms:&#39;</span><span class="p">,</span> <span class="n">natoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Number of atomic orbitals:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">nao</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Number of bands in calculation:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Number of valence electrons:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nvalence</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">convergence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span> <span class="s1">&#39;occupied&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Bands to converge:&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gpaw</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">realspace</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">get_description</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FDTD+TDDFT&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">print_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;... initialized</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">xc</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;pw&#39;</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.6</span>
            <span class="n">N_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gpts&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">h</span> <span class="ow">or</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">/</span> <span class="n">Bohr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">icell_vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="n">icell_vc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">N_c</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">Bohr</span>

            <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">rgd</span><span class="p">,</span> <span class="n">rcut</span><span class="p">,</span> <span class="n">f_r</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">gcut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">rcut</span> <span class="o">/</span> <span class="n">gamma</span>
                <span class="n">ftmp</span> <span class="o">=</span> <span class="n">rgd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f_r</span><span class="p">,</span> <span class="n">rcut</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gcut</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                <span class="n">f_r</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ftmp</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">f_r</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">filter</span>

        <span class="n">Z_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span> <span class="o">=</span> <span class="n">Setups</span><span class="p">(</span><span class="n">Z_a</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">setups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span>
                             <span class="n">xc</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_grid_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">pbc_c</span><span class="p">,</span>
                               <span class="n">domain_comm</span><span class="p">,</span> <span class="n">parsize_domain</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GridDescriptor</span><span class="p">(</span><span class="n">N_c</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">pbc_c</span><span class="p">,</span> <span class="n">domain_comm</span><span class="p">,</span>
                              <span class="n">parsize_domain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">magmom</span><span class="p">,</span> <span class="n">orbital_free</span><span class="p">,</span> <span class="n">nvalence</span><span class="p">):</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">occupations</span>

        <span class="k">if</span> <span class="n">dct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orbital_free</span><span class="p">:</span>
                <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;orbital-free&#39;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fermi-dirac&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># eV</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dct</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fixmagmom&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mom&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">gpaw.mom</span> <span class="kn">import</span> <span class="n">OccupationsMOM</span>
            <span class="n">occ</span> <span class="o">=</span> <span class="n">OccupationsMOM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">occ</span>

        <span class="n">occ</span> <span class="o">=</span> <span class="n">create_occ_calc</span><span class="p">(</span>
            <span class="n">dct</span><span class="p">,</span>
            <span class="n">parallel_layout</span><span class="o">=</span><span class="n">ParallelLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="p">),</span>
            <span class="n">fixed_magmom_value</span><span class="o">=</span><span class="n">magmom</span><span class="p">,</span>
            <span class="n">rcell</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell_cv</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">monkhorst_pack_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">N_c</span><span class="p">,</span>
            <span class="n">bz2ibzmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">bz2ibz_k</span><span class="p">,</span>
            <span class="n">nspins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span><span class="p">,</span>
            <span class="n">nelectrons</span><span class="o">=</span><span class="n">nvalence</span><span class="p">,</span>
            <span class="n">nkpts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">nibzkpts</span><span class="p">,</span>
            <span class="n">nbands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Occupation numbers:&#39;</span><span class="p">,</span> <span class="n">occ</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">occ</span>

    <span class="k">def</span> <span class="nf">create_scf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="c1"># if mode.name == &#39;lcao&#39;:</span>
        <span class="c1">#     niter_fixdensity = 0</span>
        <span class="c1"># else:</span>
        <span class="c1">#     niter_fixdensity = 2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="o">=</span> <span class="n">SCFLoop</span><span class="p">(</span>
            <span class="n">criteria</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">maxiter</span><span class="p">,</span>
            <span class="c1"># XXX make sure niter_fixdensity value is *always* set from default</span>
            <span class="c1"># Subdictionary defaults seem to not be set when user provides</span>
            <span class="c1"># e.g. {}.  We should change that so it works like the ordinary</span>
            <span class="c1"># parameters.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;niter_fixdensity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magmom_av</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">reading</span><span class="p">):</span>
        <span class="n">symm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">symmetry</span>
        <span class="k">if</span> <span class="n">symm</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
            <span class="n">symm</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;point_group&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;time_reversal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;do_not_symmetrize_the_density&#39;</span> <span class="ow">in</span> <span class="n">symm</span><span class="p">:</span>
            <span class="n">symm</span> <span class="o">=</span> <span class="n">symm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dnstd</span> <span class="o">=</span> <span class="n">symm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;do_not_symmetrize_the_density&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dnstd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Ignoring your &quot;do_not_symmetrize_the_density&quot; keyword!&#39;</span>
                <span class="k">if</span> <span class="n">reading</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="s1">&#39; Please remove it.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">external</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">symm</span> <span class="o">=</span> <span class="n">symm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">symm</span><span class="p">[</span><span class="s1">&#39;point_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">reading</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">symm</span><span class="p">[</span><span class="s1">&#39;allow_invert_aperiodic_axes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">m_av</span> <span class="o">=</span> <span class="n">magmom_av</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># round off</span>
        <span class="n">id_a</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">m_v</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">m_v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">id_a</span><span class="p">,</span> <span class="n">m_av</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="n">Symmetry</span><span class="p">(</span><span class="n">id_a</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="o">**</span><span class="n">symm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_eigensolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="c1"># Number of bands to converge:</span>
        <span class="n">nbands_converge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">convergence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span> <span class="s1">&#39;occupied&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbands_converge</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">nbands_converge</span> <span class="o">=</span> <span class="n">nbands</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nbands_converge</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nbands_converge</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nbands_converge</span> <span class="o">+=</span> <span class="n">nbands</span>
        <span class="n">eigensolver</span> <span class="o">=</span> <span class="n">get_eigensolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">eigensolver</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
        <span class="n">eigensolver</span><span class="o">.</span><span class="n">nbands_converge</span> <span class="o">=</span> <span class="n">nbands_converge</span>
        <span class="c1"># XXX Eigensolver class doesn&#39;t define an nbands_converge property</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">SIC</span><span class="p">):</span>
            <span class="n">eigensolver</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">set_eigensolver</span><span class="p">(</span><span class="n">eigensolver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Eigensolver</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">eigensolver</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">realspace</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span>

        <span class="n">big_gd</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">new_descriptor</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="c1"># Check whether grid is too small.  8 is smallest admissible.</span>
        <span class="c1"># (we decide this by how difficult it is to make the tests pass)</span>
        <span class="c1"># (Actually it depends on stencils!  But let the user deal with it)</span>
        <span class="n">N_c</span> <span class="o">=</span> <span class="n">big_gd</span><span class="o">.</span><span class="n">get_size_of_global_array</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">too_small</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">N_c</span> <span class="o">/</span> <span class="n">big_gd</span><span class="o">.</span><span class="n">parsize_c</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;augment_grids&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">too_small</span> <span class="ow">and</span>
            <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;pw&#39;</span><span class="p">):</span>
            <span class="n">aux_gd</span> <span class="o">=</span> <span class="n">big_gd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_gd</span> <span class="o">=</span> <span class="n">gd</span>

        <span class="n">redistributor</span> <span class="o">=</span> <span class="n">GridRedistributor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kptband_comm</span><span class="p">,</span>
                                          <span class="n">gd</span><span class="p">,</span> <span class="n">aux_gd</span><span class="p">)</span>

        <span class="c1"># Construct grid descriptor for fine grids for densities</span>
        <span class="c1"># and potentials:</span>
        <span class="n">finegd</span> <span class="o">=</span> <span class="n">aux_gd</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">gd</span><span class="o">=</span><span class="n">gd</span><span class="p">,</span> <span class="n">finegd</span><span class="o">=</span><span class="n">finegd</span><span class="p">,</span>
            <span class="n">nspins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span><span class="p">,</span>
            <span class="n">collinear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">collinear</span><span class="p">,</span>
            <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">charge</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">core_charge</span><span class="p">,</span>
            <span class="n">redistributor</span><span class="o">=</span><span class="n">redistributor</span><span class="p">,</span>
            <span class="n">background_charge</span><span class="o">=</span><span class="n">background</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">realspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">RealSpaceDensity</span><span class="p">(</span><span class="n">stencil</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ecut</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">ecut</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ecut</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">ReciprocalSpaceDensity</span><span class="p">(</span><span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">realspace</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">xc</span><span class="p">):</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">gd</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">gd</span><span class="p">,</span> <span class="n">finegd</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">finegd</span><span class="p">,</span>
            <span class="n">nspins</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">nspins</span><span class="p">,</span>
            <span class="n">collinear</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">collinear</span><span class="p">,</span>
            <span class="n">setups</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">setups</span><span class="p">,</span>
            <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span>
            <span class="n">xc</span><span class="o">=</span><span class="n">xc</span><span class="p">,</span>
            <span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>
            <span class="n">redistributor</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">redistributor</span><span class="p">,</span>
            <span class="n">vext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">external</span><span class="p">,</span>
            <span class="n">psolver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">poissonsolver</span><span class="p">,</span>
            <span class="n">charge</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">realspace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">RealSpaceHamiltonian</span><span class="p">(</span><span class="n">stencil</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xc</span><span class="o">.</span><span class="n">set_grid_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">finegd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This code will work if dens.redistributor uses</span>
            <span class="c1"># ordinary density.gd as aux_gd</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">finegd</span>

            <span class="n">xc_redist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;augment_grids&#39;</span><span class="p">]:</span>
                <span class="kn">from</span> <span class="nn">gpaw.grid_descriptor</span> <span class="kn">import</span> <span class="n">BadGridError</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">aux_gd</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">new_descriptor</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BadGridError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">warnings</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Ignoring augment_grids: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bcast_comm</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">redistributor</span><span class="o">.</span><span class="n">broadcast_comm</span>
                    <span class="n">xc_redist</span> <span class="o">=</span> <span class="n">GridRedistributor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">bcast_comm</span><span class="p">,</span>
                                                  <span class="n">gd</span><span class="p">,</span> <span class="n">aux_gd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">ReciprocalSpaceHamiltonian</span><span class="p">(</span>
                <span class="n">pd2</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">pd2</span><span class="p">,</span> <span class="n">pd3</span><span class="o">=</span><span class="n">dens</span><span class="o">.</span><span class="n">pd3</span><span class="p">,</span> <span class="n">realpbc_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span>
                <span class="n">xc_redistributor</span><span class="o">=</span><span class="n">xc_redist</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xc</span><span class="o">.</span><span class="n">set_grid_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">xc_gd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">soc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;soc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_kpoint_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nspins</span><span class="p">):</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># Zero cell vectors that are not periodic so that ASE&#39;s</span>
        <span class="c1"># kpts2ndarray can handle 1-d and 2-d correctly:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                      <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="n">bzkpts_kc</span> <span class="o">=</span> <span class="n">kpts2ndarray</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">kpts</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>

        <span class="n">kpt_refine</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kpt_refine&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kpt_refine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kd</span> <span class="o">=</span> <span class="n">KPointDescriptor</span><span class="p">(</span><span class="n">bzkpts_kc</span><span class="p">,</span> <span class="n">nspins</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Set symmetry&#39;</span><span class="p">)</span>
            <span class="n">kd</span><span class="o">.</span><span class="n">set_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;Set symmetry&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Set k-point refinement&#39;</span><span class="p">)</span>
            <span class="n">kd</span> <span class="o">=</span> <span class="n">create_kpoint_descriptor_with_refinement</span><span class="p">(</span>
                <span class="n">kpt_refine</span><span class="p">,</span>
                <span class="n">bzkpts_kc</span><span class="p">,</span> <span class="n">nspins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>
                <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s1">&#39;Set k-point refinement&#39;</span><span class="p">)</span>
            <span class="c1"># Update quantities which might have changed, if symmetry</span>
            <span class="c1"># was changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="n">kd</span><span class="o">.</span><span class="n">symmetry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">set_symmetry</span><span class="p">(</span><span class="n">kd</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">kd</span>

    <span class="k">def</span> <span class="nf">create_wave_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">realspace</span><span class="p">,</span>
                              <span class="n">nspins</span><span class="p">,</span> <span class="n">collinear</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">nao</span><span class="p">,</span> <span class="n">nvalence</span><span class="p">,</span>
                              <span class="n">setups</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">pbc_c</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">xc</span><span class="p">):</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">kd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_kpoint_descriptor</span><span class="p">(</span><span class="n">nspins</span><span class="p">)</span>

        <span class="n">parallelization</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">Parallelization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>
                                              <span class="n">kd</span><span class="o">.</span><span class="n">nibzkpts</span><span class="p">)</span>

        <span class="n">parsize_kpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;kpt&#39;</span><span class="p">]</span>
        <span class="n">parsize_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span>
        <span class="n">parsize_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">HybridXC</span><span class="p">):</span>
            <span class="n">parsize_kpt</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">parsize_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">size</span>
            <span class="n">parsize_bands</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">ndomains</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parsize_domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ndomains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">parsize_domain</span><span class="p">)</span>
        <span class="n">parallelization</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">kpt</span><span class="o">=</span><span class="n">parsize_kpt</span><span class="p">,</span>
                            <span class="n">domain</span><span class="o">=</span><span class="n">ndomains</span><span class="p">,</span>
                            <span class="n">band</span><span class="o">=</span><span class="n">parsize_bands</span><span class="p">)</span>
        <span class="n">comms</span> <span class="o">=</span> <span class="n">parallelization</span><span class="o">.</span><span class="n">build_communicators</span><span class="p">()</span>
        <span class="n">domain_comm</span> <span class="o">=</span> <span class="n">comms</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
        <span class="n">kpt_comm</span> <span class="o">=</span> <span class="n">comms</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">band_comm</span> <span class="o">=</span> <span class="n">comms</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
        <span class="n">kptband_comm</span> <span class="o">=</span> <span class="n">comms</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
        <span class="n">domainband_comm</span> <span class="o">=</span> <span class="n">comms</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comms</span> <span class="o">=</span> <span class="n">comms</span>

        <span class="n">kd</span><span class="o">.</span><span class="n">set_communicator</span><span class="p">(</span><span class="n">kpt_comm</span><span class="p">)</span>

        <span class="n">parstride_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;stridebands&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parstride_bands</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;stridebands is unreliable&#39;</span><span class="p">)</span>

        <span class="n">bd</span> <span class="o">=</span> <span class="n">BandDescriptor</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">band_comm</span><span class="p">,</span> <span class="n">parstride_bands</span><span class="p">)</span>

        <span class="c1"># Construct grid descriptor for coarse grids for wave functions:</span>
        <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_grid_descriptor</span><span class="p">(</span><span class="n">N_c</span><span class="p">,</span> <span class="n">cell_cv</span><span class="p">,</span> <span class="n">pbc_c</span><span class="p">,</span>
                                         <span class="n">domain_comm</span><span class="p">,</span> <span class="n">parsize_domain</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">.</span><span class="n">force_complex_dtype</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">collinear</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kd</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span>

        <span class="n">wfs_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gd</span><span class="o">=</span><span class="n">gd</span><span class="p">,</span> <span class="n">nvalence</span><span class="o">=</span><span class="n">nvalence</span><span class="p">,</span> <span class="n">setups</span><span class="o">=</span><span class="n">setups</span><span class="p">,</span>
                          <span class="n">bd</span><span class="o">=</span><span class="n">bd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">kd</span><span class="o">=</span><span class="n">kd</span><span class="p">,</span>
                          <span class="n">kptband_comm</span><span class="o">=</span><span class="n">kptband_comm</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;sl_auto&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">compiled_with_sl</span><span class="p">():</span>
            <span class="c1"># Choose scalapack parallelization automatically</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sl_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;sl_auto&#39;</span> <span class="ow">and</span>
                    <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot use &#39;sl_auto&#39; together &quot;</span>
                                     <span class="s2">&quot;with &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="n">max_scalapack_cpus</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span>
            <span class="n">sl_default</span> <span class="o">=</span> <span class="n">suggest_blocking</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">max_scalapack_cpus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sl_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;sl_default&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">collinear</span>
            <span class="c1"># Layouts used for general diagonalizer</span>
            <span class="n">sl_lcao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;sl_lcao&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sl_lcao</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sl_lcao</span> <span class="o">=</span> <span class="n">sl_default</span>

            <span class="n">elpasolver</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;use_elpa&#39;</span><span class="p">]:</span>
                <span class="n">elpasolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;elpasolver&#39;</span><span class="p">]</span>
            <span class="n">lcaoksl</span> <span class="o">=</span> <span class="n">get_KohnSham_layouts</span><span class="p">(</span><span class="n">sl_lcao</span><span class="p">,</span> <span class="s1">&#39;lcao&#39;</span><span class="p">,</span>
                                           <span class="n">gd</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">domainband_comm</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span>
                                           <span class="n">nao</span><span class="o">=</span><span class="n">nao</span><span class="p">,</span> <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span>
                                           <span class="n">elpasolver</span><span class="o">=</span><span class="n">elpasolver</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">lcaoksl</span><span class="p">,</span> <span class="o">**</span><span class="n">wfs_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;fd&#39;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;pw&#39;</span><span class="p">:</span>
            <span class="c1"># Use (at most) all available LCAO for initialization</span>
            <span class="n">lcaonbands</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">nao</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">lcaobd</span> <span class="o">=</span> <span class="n">BandDescriptor</span><span class="p">(</span><span class="n">lcaonbands</span><span class="p">,</span> <span class="n">band_comm</span><span class="p">,</span>
                                        <span class="n">parstride_bands</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">initksl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Layouts used for general diagonalizer</span>
                <span class="c1"># (LCAO initialization)</span>
                <span class="n">sl_lcao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;sl_lcao&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sl_lcao</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sl_lcao</span> <span class="o">=</span> <span class="n">sl_default</span>
                <span class="n">initksl</span> <span class="o">=</span> <span class="n">get_KohnSham_layouts</span><span class="p">(</span><span class="n">sl_lcao</span><span class="p">,</span> <span class="s1">&#39;lcao&#39;</span><span class="p">,</span>
                                               <span class="n">gd</span><span class="p">,</span> <span class="n">lcaobd</span><span class="p">,</span> <span class="n">domainband_comm</span><span class="p">,</span>
                                               <span class="n">dtype</span><span class="p">,</span> <span class="n">nao</span><span class="o">=</span><span class="n">nao</span><span class="p">,</span>
                                               <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>

            <span class="n">reuse_wfs_method</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reuse_wfs_method&#39;</span><span class="p">,</span> <span class="s1">&#39;paw&#39;</span><span class="p">)</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">domainband_comm</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">[</span><span class="s1">&#39;sl_diagonalize&#39;</span><span class="p">]</span> <span class="ow">or</span>
                                       <span class="n">sl_default</span> <span class="ow">or</span>
                                       <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">initksl</span><span class="p">,</span>
                            <span class="n">reuse_wfs_method</span><span class="o">=</span><span class="n">reuse_wfs_method</span><span class="p">,</span>
                            <span class="n">collinear</span><span class="o">=</span><span class="n">collinear</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">wfs_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collinear</span><span class="o">=</span><span class="n">collinear</span><span class="p">,</span> <span class="o">**</span><span class="n">wfs_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dry_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Can be overridden like in gpaw.atom.atompaw</span>
        <span class="n">print_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="n">print_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">magmom_av</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Write timing info now before the interpreter shuts down:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Disable timing output during shut-down:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span>

        <span class="k">raise</span> <span class="ne">SystemExit</span>

    <span class="k">def</span> <span class="nf">get_atomic_electrostatic_potentials</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array1D</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the electrostatic potential at the atomic sites.</span>

<span class="sd">        Return list of energies in eV, one for each atom:</span>

<span class="sd">        :::</span>

<span class="sd">              / _ ~  _  ^a  _ _a</span>
<span class="sd">          Y   |dr v (r) g  (r-R )</span>
<span class="sd">           00 /    H     00</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ham</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_positions</span><span class="p">()</span>
        <span class="n">dens</span><span class="o">.</span><span class="n">interpolate_pseudo_density</span><span class="p">()</span>
        <span class="n">dens</span><span class="o">.</span><span class="n">calculate_pseudo_charge</span><span class="p">()</span>
        <span class="n">ham</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>
        <span class="n">W_aL</span> <span class="o">=</span> <span class="n">ham</span><span class="o">.</span><span class="n">calculate_atomic_hamiltonians</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>
        <span class="n">W_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">W_L</span> <span class="ow">in</span> <span class="n">W_aL</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">W_a</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Ha</span>
        <span class="n">W_aL</span><span class="o">.</span><span class="n">partition</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W_a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">W_a</span>

    <span class="k">def</span> <span class="nf">linearize_to_xc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newxc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Linearize Hamiltonian to difference XC functional.</span>

<span class="sd">        Used in real time TDDFT to perform calculations with various kernels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newxc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">newxc</span> <span class="o">=</span> <span class="n">XC</span><span class="p">(</span><span class="n">newxc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Linearizing xc-hamiltonian to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">newxc</span><span class="p">))</span>
        <span class="n">newxc</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">linearize_to_xc</span><span class="p">(</span><span class="n">newxc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register observer function to run during the SCF cycle.</span>

<span class="sd">        Call *function* using *args* and</span>
<span class="sd">        *kwargs* as arguments.</span>

<span class="sd">        If *n* is positive, then</span>
<span class="sd">        *function* will be called every *n* SCF iterations + the</span>
<span class="sd">        final iteration if it would not be otherwise</span>

<span class="sd">        If *n* is negative, then *function* will only be</span>
<span class="sd">        called on iteration *abs(n)*.</span>

<span class="sd">        If *n* is 0, then *function* will only be called</span>
<span class="sd">        on convergence&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">slf</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__self__</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slf</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c1"># function is a bound method of self.  Store the name</span>
                <span class="c1"># of the method and avoid circular reference:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Replace self in args with another unique reference</span>
        <span class="c1"># to avoid circular reference</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;self_ref&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_ref</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="n">self_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_ref</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">self_</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">self</span> <span class="k">else</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">function</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">call_observers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call all registered callback functions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">function</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observers</span><span class="p">:</span>
            <span class="n">call</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Call every n iterations, including the last</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">iter</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">final</span><span class="p">:</span>
                    <span class="n">call</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Call only on iteration n</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">final</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">iter</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">call</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Call only on convergence</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">final</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">call</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
                <span class="c1"># Replace self reference with self</span>
                <span class="n">self_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_ref</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="n">self_</span> <span class="k">else</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
                <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_reference_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">Eref</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_homo_lumo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return HOMO and LUMO eigenvalues.</span>

<span class="sd">        By default, return the true HOMO-LUMO eigenvalues (spin=None).</span>

<span class="sd">        If spin is 0 or 1, return HOMO-LUMO eigenvalues taken among</span>
<span class="sd">        only those states with the given spin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">get_homo_lumo</span><span class="p">(</span><span class="n">spin</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">estimate_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate memory use of this object.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;Hamiltonian&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;Wavefunctions&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">)]:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">estimate_memory</span><span class="p">(</span><span class="n">mem</span><span class="o">.</span><span class="n">subnode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">print_memory_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print estimated memory usage for PAW object and components.</span>

<span class="sd">        maxdepth is the maximum nesting level of displayed components.</span>

<span class="sd">        The PAW object must be initialize()&#39;d, but needs not have large</span>
<span class="sd">        arrays allocated.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE.  This should work with &quot;--dry-run=N&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># However, the initial overhead estimate is wrong if this method</span>
        <span class="c1"># is called within a real mpirun/gpaw-python context.</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Memory estimate:&#39;</span><span class="p">)</span>

        <span class="n">mem_init</span> <span class="o">=</span> <span class="n">maxrss</span><span class="p">()</span>  <span class="c1"># initial overhead includes part of Hamiltonian!</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;  Process memory now: </span><span class="si">%.2f</span><span class="s1"> MiB&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mem_init</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">mem</span> <span class="o">=</span> <span class="n">MemNode</span><span class="p">(</span><span class="s1">&#39;Calculator&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mem</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimate_memory</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Attribute error: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Some object probably lacks estimate_memory() method&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Memory breakdown may be incomplete&#39;</span><span class="p">)</span>
        <span class="n">mem</span><span class="o">.</span><span class="n">calculate_size</span><span class="p">()</span>
        <span class="n">mem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">converge_wave_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converge the wave-functions if not present.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">psit_nG</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">psit_nG</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">initialize_wave_functions_from_restart_file</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">system_changes</span><span class="o">=</span><span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>

    <span class="k">def</span> <span class="nf">diagonalize_full_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">scalapack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">expert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">diagonalize_full_hamiltonian</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="n">nbands</span><span class="p">,</span> <span class="n">ecut</span><span class="p">,</span> <span class="n">scalapack</span><span class="p">,</span> <span class="n">expert</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">nbands</span> <span class="o">=</span> <span class="n">nbands</span>

    <span class="k">def</span> <span class="nf">get_number_of_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the number of bands.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span>

    <span class="k">def</span> <span class="nf">get_xc_functional</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the XC-functional identifier.</span>

<span class="sd">        &#39;LDA&#39;, &#39;PBE&#39;, ...&quot;&quot;&quot;</span>

        <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xc&#39;</span><span class="p">,</span> <span class="s1">&#39;LDA&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xc</span>

    <span class="k">def</span> <span class="nf">get_number_of_spins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span>

    <span class="k">def</span> <span class="nf">get_spin_polarized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is it a spin-polarized calculation?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_bz_k_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the k-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">bzk_kc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_ibz_k_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return k-points in the irreducible part of the Brillouin zone.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">ibzk_kc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_bz_to_ibz_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return indices from BZ to IBZ.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">bz2ibz_k</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_k_point_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Weights of the k-points.</span>

<span class="sd">        The sum of all weights is one.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">weight_k</span>

    <span class="k">def</span> <span class="nf">get_pseudo_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridrefinement</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pseudo-density array.</span>

<span class="sd">        If *spin* is not given, then the total density is returned.</span>
<span class="sd">        Otherwise, the spin up or down density is returned (spin=0 or</span>
<span class="sd">        1).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">gridrefinement</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nt_sG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nt_sG</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">gd</span>
        <span class="k">elif</span> <span class="n">gridrefinement</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nt_sg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">interpolate_pseudo_density</span><span class="p">()</span>
            <span class="n">nt_sG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nt_sg</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">finegd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nt_G</span> <span class="o">=</span> <span class="n">nt_sG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nt_G</span> <span class="o">=</span> <span class="n">nt_sG</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nt_G</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nt_sG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nt_G</span> <span class="o">=</span> <span class="n">nt_sG</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">nt_G</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">nt_G</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="n">broadcast</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nt_G</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
            <span class="n">nt_G</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">zero_pad</span><span class="p">(</span><span class="n">nt_G</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nt_G</span> <span class="o">/</span> <span class="n">Bohr</span><span class="o">**</span><span class="mi">3</span>

    <span class="n">get_pseudo_valence_density</span> <span class="o">=</span> <span class="n">get_pseudo_density</span>  <span class="c1"># Don&#39;t use this one!</span>

    <span class="k">def</span> <span class="nf">get_effective_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pseudo effective-potential.&quot;&quot;&quot;</span>
        <span class="n">vt_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">vt_sG</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                                           <span class="n">broadcast</span><span class="o">=</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vt_G</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
            <span class="n">vt_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">zero_pad</span><span class="p">(</span><span class="n">vt_G</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vt_G</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_electrostatic_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the electrostatic potential.</span>

<span class="sd">        This is the potential from the pseudo electron density and the</span>
<span class="sd">        PAW-compensation charges.  So, the electrostatic potential will</span>
<span class="sd">        only be correct outside the PAW augmentation spheres.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ham</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span>
        <span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_positions</span><span class="p">()</span>
        <span class="n">dens</span><span class="o">.</span><span class="n">interpolate_pseudo_density</span><span class="p">()</span>
        <span class="n">dens</span><span class="o">.</span><span class="n">calculate_pseudo_charge</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ham</span><span class="o">.</span><span class="n">get_electrostatic_potential</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_pseudo_density_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integrated density corrections.</span>

<span class="sd">        Returns the integrated value of the difference between the pseudo-</span>
<span class="sd">        and the all-electron densities at each atom.  These are the numbers</span>
<span class="sd">        you should add to the result of doing e.g. Bader analysis on the</span>
<span class="sd">        pseudo density.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">get_correction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">get_correction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))]</span>
                             <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">get_all_electron_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridrefinement</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">skip_core</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return reconstructed all-electron density array.&quot;&quot;&quot;</span>
        <span class="n">n_sG</span><span class="p">,</span> <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">get_all_electron_density</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">gridrefinement</span><span class="o">=</span><span class="n">gridrefinement</span><span class="p">,</span> <span class="n">skip_core</span><span class="o">=</span><span class="n">skip_core</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n_G</span> <span class="o">=</span> <span class="n">n_sG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_G</span> <span class="o">=</span> <span class="n">n_sG</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nspins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n_G</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_sG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_G</span> <span class="o">=</span> <span class="n">n_sG</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">collect</span><span class="p">:</span>
            <span class="n">n_G</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">n_G</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="n">broadcast</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_G</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
            <span class="n">n_G</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">zero_pad</span><span class="p">(</span><span class="n">n_G</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">n_G</span> <span class="o">/</span> <span class="n">Bohr</span><span class="o">**</span><span class="mi">3</span>

    <span class="k">def</span> <span class="nf">get_fermi_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Fermi-level.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are two Fermi-levels!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_fermi_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Fermi-levels in case of fixed-magmom.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is only one Fermi-level!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">fermi_levels</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_wigner_seitz_densities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the weight of the spin-density in Wigner-Seitz cells</span>
<span class="sd">        around each atom.</span>

<span class="sd">        The density assigned to each atom is relative to the neutral atom,</span>
<span class="sd">        i.e. the density sums to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gpaw.analyse.wignerseitz</span> <span class="kn">import</span> <span class="n">wignerseitz</span>
        <span class="n">atom_index</span> <span class="o">=</span> <span class="n">wignerseitz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">nt_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">nt_sG</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="n">weight_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="c1"># XXX Optimize! No need to integrate in zero-region</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">atom_index</span> <span class="o">==</span> <span class="n">a</span><span class="p">,</span>
                                                    <span class="n">nt_G</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">get_correction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
            <span class="n">weight_a</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth</span> <span class="o">+</span> <span class="n">correction</span>

        <span class="k">return</span> <span class="n">weight_a</span>

    <span class="k">def</span> <span class="nf">get_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The total DOS.</span>

<span class="sd">        Fold eigenvalues with Gaussians, and put on an energy grid.</span>

<span class="sd">        returns an (energies, dos) tuple, where energies are relative to the</span>
<span class="sd">        vacuum level for non-periodic systems, and the average potential for</span>
<span class="sd">        periodic systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="n">w_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">weight_k</span>
        <span class="n">Nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w_k</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nb</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w_k</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nb</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">w_k</span><span class="p">):</span>
            <span class="n">energies</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">Nb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">Nb</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">Nb</span>

        <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">fold</span>
        <span class="k">return</span> <span class="n">fold</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_wigner_seitz_ldos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Local Density of States, using a Wigner-Seitz basis function.</span>

<span class="sd">        Project wave functions onto a Wigner-Seitz box at atom ``a``, and</span>
<span class="sd">        use this as weight when summing the eigenvalues.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">fold</span><span class="p">,</span> <span class="n">raw_wignerseitz_LDOS</span>
        <span class="n">energies</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">raw_wignerseitz_LDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fold</span><span class="p">(</span><span class="n">energies</span> <span class="o">*</span> <span class="n">Ha</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_orbital_ldos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span>
                         <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">angular</span><span class="o">=</span><span class="s1">&#39;spdf&#39;</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">nbands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spinorbit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Local Density of States, using atomic orbital basis functions.</span>

<span class="sd">        Project wave functions onto an atom orbital at atom ``a``, and</span>
<span class="sd">        use this as weight when summing the eigenvalues.</span>

<span class="sd">        The atomic orbital has angular momentum ``angular``, which can be</span>
<span class="sd">        &#39;s&#39;, &#39;p&#39;, &#39;d&#39;, &#39;f&#39;, or any combination (e.g. &#39;sdf&#39;).</span>

<span class="sd">        An integer value for ``angular`` can also be used to specify a specific</span>
<span class="sd">        projector function to project onto.</span>

<span class="sd">        Setting nbands limits the number of bands included. This speeds up the</span>
<span class="sd">        calculation if one has many bands in the calculator but is only</span>
<span class="sd">        interested in the DOS at low energies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">fold</span><span class="p">,</span> <span class="n">raw_orbital_LDOS</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">spinorbit</span><span class="p">:</span>
            <span class="n">energies</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">raw_orbital_LDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">angular</span><span class="p">,</span>
                                                 <span class="n">nbands</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span>
                <span class="s1">&#39;Please use GPAW.dos(soc=True, ...).raw_pdos(...)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fold</span><span class="p">(</span><span class="n">energies</span> <span class="o">*</span> <span class="n">Ha</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lcao_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">npts</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get density of states projected onto orbitals in LCAO mode.</span>

<span class="sd">        basis_indices is a list of indices of basis functions on which</span>
<span class="sd">        to project.  To specify all basis functions on a set of atoms,</span>
<span class="sd">        you can supply atom_indices instead.  Both cannot be given</span>
<span class="sd">        simultaneously.&quot;&quot;&quot;</span>

        <span class="n">both_none</span> <span class="o">=</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basis_indices</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">neither_none</span> <span class="o">=</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basis_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">both_none</span> <span class="ow">or</span> <span class="n">neither_none</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please give either atom_indices or &#39;</span>
                             <span class="s1">&#39;basis_indices but not both&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">S_qMM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">RestartLCAODOS</span>
            <span class="n">lcaodos</span> <span class="o">=</span> <span class="n">RestartLCAODOS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">LCAODOS</span>
            <span class="n">lcaodos</span> <span class="o">=</span> <span class="n">LCAODOS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_indices</span> <span class="o">=</span> <span class="n">lcaodos</span><span class="o">.</span><span class="n">get_atom_indices</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>

        <span class="n">eps_n</span><span class="p">,</span> <span class="n">w_n</span> <span class="o">=</span> <span class="n">lcaodos</span><span class="o">.</span><span class="n">get_subspace_pdos</span><span class="p">(</span><span class="n">basis_indices</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">fold</span>
        <span class="k">return</span> <span class="n">fold</span><span class="p">(</span><span class="n">eps_n</span> <span class="o">*</span> <span class="n">Ha</span><span class="p">,</span> <span class="n">w_n</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_electron_ldos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">npts</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">wf_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P_aui</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Projected Density of States, using all-electron wavefunctions.</span>

<span class="sd">        Projects onto a pseudo_wavefunctions (wf_k) corresponding to some band</span>
<span class="sd">        n and uses P_aui ([paw.nuclei[a].P_uni[:,n,:] for a in atoms]) to</span>
<span class="sd">        obtain the all-electron overlaps.</span>
<span class="sd">        Instead of projecting onto a wavefunction, a molecular orbital can</span>
<span class="sd">        be specified by a linear combination of weights (lc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gpaw.utilities.dos</span> <span class="kn">import</span> <span class="n">all_electron_LDOS</span><span class="p">,</span> <span class="n">fold</span>

        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_electron_LDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span>
                                     <span class="n">wf_k</span><span class="o">=</span><span class="n">wf_k</span><span class="p">,</span> <span class="n">P_aui</span><span class="o">=</span><span class="n">P_aui</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="n">energies</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">all_electron_LDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span>
                                              <span class="n">lc</span><span class="o">=</span><span class="n">lc</span><span class="p">,</span> <span class="n">wf_k</span><span class="o">=</span><span class="n">wf_k</span><span class="p">,</span> <span class="n">P_aui</span><span class="o">=</span><span class="n">P_aui</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fold</span><span class="p">(</span><span class="n">energies</span> <span class="o">*</span> <span class="n">Ha</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pseudo_wave_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kpt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pseudo-wave-function array.</span>

<span class="sd">        Units: 1/Angstrom^(3/2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">positions_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_positions</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
            <span class="n">psit_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pseudo_wave_function</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">kpt</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">broadcast</span><span class="p">,</span>
                                                   <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">periodic</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">psit_G</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">zero_pad</span><span class="p">(</span><span class="n">psit_G</span><span class="p">)</span>

        <span class="n">psit_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">get_wave_function_array</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">kpt</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span>
                                                  <span class="n">periodic</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">broadcast</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psit_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                           <span class="n">global_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">psit_G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">psit_G</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">psit_G</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">psit_G</span> <span class="o">/</span> <span class="n">Bohr</span><span class="o">**</span><span class="mf">1.5</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">psit_G</span> <span class="o">/</span> <span class="n">Bohr</span><span class="o">**</span><span class="mf">1.5</span>

    <span class="k">def</span> <span class="nf">get_eigenvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return eigenvalue array.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kpt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">nibzkpts</span><span class="p">,</span> <span class="n">kpt</span>
        <span class="n">eps_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">collect_eigenvalues</span><span class="p">(</span><span class="n">kpt</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">broadcast</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">eps_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">eps_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eps_n</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">get_occupation_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return occupation array.&quot;&quot;&quot;</span>
        <span class="n">f_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">collect_occupations</span><span class="p">(</span><span class="n">kpt</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">broadcast</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">f_n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f_n</span>

    <span class="k">def</span> <span class="nf">get_xc_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="n">XC</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
        <span class="n">xc</span><span class="o">.</span><span class="n">set_grid_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">finegd</span><span class="p">)</span>
        <span class="n">xc</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="p">)</span>
        <span class="n">xc</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xc</span><span class="o">.</span><span class="n">orbital_dependent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converge_wave_functions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span><span class="o">.</span><span class="n">get_xc_difference</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ha</span>

    <span class="k">def</span> <span class="nf">initial_wannier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialwannier</span><span class="p">,</span> <span class="n">kpointgrid</span><span class="p">,</span> <span class="n">fixedstates</span><span class="p">,</span>
                        <span class="n">edf</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">nbands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initial guess for the shape of wannier functions.</span>

<span class="sd">        Use initial guess for wannier orbitals to determine rotation</span>
<span class="sd">        matrices U and C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ase.dft.wannier</span> <span class="kn">import</span> <span class="n">rotation_from_projection</span>
        <span class="n">proj_knw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projections</span><span class="p">(</span><span class="n">initialwannier</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span>
        <span class="n">U_kww</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_kul</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">proj_nw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fixedstates</span><span class="p">,</span> <span class="n">proj_knw</span><span class="p">):</span>
            <span class="n">U_ww</span><span class="p">,</span> <span class="n">C_ul</span> <span class="o">=</span> <span class="n">rotation_from_projection</span><span class="p">(</span><span class="n">proj_nw</span><span class="p">[:</span><span class="n">nbands</span><span class="p">],</span>
                                                  <span class="n">fixed</span><span class="p">,</span>
                                                  <span class="n">ortho</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">U_kww</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">U_ww</span><span class="p">)</span>
            <span class="n">C_kul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_ul</span><span class="p">)</span>

        <span class="n">U_kww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_kww</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">C_kul</span><span class="p">,</span> <span class="n">U_kww</span>

    <span class="k">def</span> <span class="nf">get_wannier_localization_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">dirG</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span>
                                        <span class="n">nextkpoint</span><span class="p">,</span> <span class="n">G_I</span><span class="p">,</span> <span class="n">spin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate integrals for maximally localized Wannier functions.&quot;&quot;&quot;</span>

        <span class="c1"># Due to orthorhombic cells, only one component of dirG is non-zero.</span>
        <span class="n">k_kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">bzk_kc</span>
        <span class="n">G_c</span> <span class="o">=</span> <span class="n">k_kc</span><span class="p">[</span><span class="n">nextkpoint</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_kc</span><span class="p">[</span><span class="n">kpoint</span><span class="p">]</span> <span class="o">-</span> <span class="n">G_I</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wannier_integrals</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span>
                                          <span class="n">nextkpoint</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">nbands</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_wannier_integrals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">nbands</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate integrals for maximally localized Wannier functions.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">nspins</span>
        <span class="n">kpt_rank</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">ibzk_kc</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">))</span>
        <span class="n">kpt_rank1</span><span class="p">,</span> <span class="n">u1</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">k1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">ibzk_kc</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">))</span>
        <span class="n">kpt_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span>

        <span class="c1"># XXX not for the kpoint/spin parallel case</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># If calc is a save file, read in tar references to memory</span>
        <span class="c1"># For lcao mode just initialize the wavefunctions from the</span>
        <span class="c1"># calculated lcao coefficients</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;lcao&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">initialize_wave_functions_from_lcao</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">initialize_wave_functions_from_restart_file</span><span class="p">()</span>

        <span class="c1"># Get pseudo part</span>
        <span class="n">Z_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">wannier_matrix</span><span class="p">(</span><span class="n">kpt_u</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">psit_nG</span><span class="p">,</span>
                                          <span class="n">kpt_u</span><span class="p">[</span><span class="n">u1</span><span class="p">]</span><span class="o">.</span><span class="n">psit_nG</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">nbands</span><span class="p">)</span>

        <span class="c1"># Add corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_wannier_correction</span><span class="p">(</span><span class="n">Z_nn</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">nbands</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_nn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Z_nn</span>

    <span class="k">def</span> <span class="nf">add_wannier_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z_nn</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">nbands</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Calculate the correction to the wannier integrals.</span>

<span class="sd">        See: (Eq. 27 ref1)::</span>

<span class="sd">                          -i G.r</span>
<span class="sd">            Z   = &lt;psi | e      |psi &gt;</span>
<span class="sd">             nm       n             m</span>

<span class="sd">                           __                __</span>
<span class="sd">                   ~      \              a  \     a*   a    a</span>
<span class="sd">            Z    = Z    +  ) exp[-i G . R ]  )   P   dO    P</span>
<span class="sd">             nmx    nmx   /__            x  /__   ni   ii&#39;  mi&#39;</span>

<span class="sd">                           a                 ii&#39;</span>

<span class="sd">        Note that this correction is an approximation that assumes the</span>
<span class="sd">        exponential varies slowly over the extent of the augmentation sphere.</span>

<span class="sd">        ref1: Thygesen et al, Phys. Rev. B 72, 125119 (2005)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">nbands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span>

        <span class="n">P_ani</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">P_ani</span>
        <span class="n">P1_ani</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">[</span><span class="n">u1</span><span class="p">]</span><span class="o">.</span><span class="n">P_ani</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">P_ni</span> <span class="ow">in</span> <span class="n">P_ani</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">P_ni</span> <span class="o">=</span> <span class="n">P_ani</span><span class="p">[</span><span class="n">a</span><span class="p">][:</span><span class="n">nbands</span><span class="p">]</span>
            <span class="n">P1_ni</span> <span class="o">=</span> <span class="n">P1_ani</span><span class="p">[</span><span class="n">a</span><span class="p">][:</span><span class="n">nbands</span><span class="p">]</span>
            <span class="n">dO_ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dO_ii</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
            <span class="n">Z_nn</span> <span class="o">+=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P_ni</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dO_ii</span><span class="p">),</span> <span class="n">P1_ni</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locfun</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Project wave functions onto localized functions</span>

<span class="sd">        Determine the projections of the Kohn-Sham eigenstates</span>
<span class="sd">        onto specified localized functions of the format::</span>

<span class="sd">          locfun = [[spos_c, l, sigma], [...]]</span>

<span class="sd">        spos_c can be an atom index, or a scaled position vector. l is</span>
<span class="sd">        the angular momentum, and sigma is the (half-) width of the</span>
<span class="sd">        radial gaussian.</span>

<span class="sd">        Return format is::</span>

<span class="sd">          f_kni = &lt;psi_kn | f_i&gt;</span>

<span class="sd">        where psi_kn are the wave functions, and f_i are the specified</span>
<span class="sd">        localized functions.</span>

<span class="sd">        As a special case, locfun can be the string &#39;projectors&#39;, in which</span>
<span class="sd">        case the bound state projectors are used as localized functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span>

        <span class="k">if</span> <span class="n">locfun</span> <span class="o">==</span> <span class="s1">&#39;projectors&#39;</span><span class="p">:</span>
            <span class="n">f_kin</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kpt</span><span class="o">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">spin</span><span class="p">:</span>
                    <span class="n">f_in</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">P_ni</span> <span class="ow">in</span> <span class="n">kpt</span><span class="o">.</span><span class="n">P_ani</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">setup</span> <span class="o">=</span> <span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">l_j</span><span class="p">,</span> <span class="n">setup</span><span class="o">.</span><span class="n">n_j</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                    <span class="n">f_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_ni</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">f_kin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
            <span class="n">f_kni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_kin</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f_kni</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">factorial</span> <span class="k">as</span> <span class="n">fac</span>

        <span class="kn">from</span> <span class="nn">gpaw.lfc</span> <span class="kn">import</span> <span class="n">LocalizedFunctionsCollection</span> <span class="k">as</span> <span class="n">LFC</span>
        <span class="kn">from</span> <span class="nn">gpaw.spline</span> <span class="kn">import</span> <span class="n">Spline</span>

        <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="o">.</span><span class="n">ibzk_kc</span><span class="p">)</span>
        <span class="n">nbf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">locfun</span><span class="p">])</span>
        <span class="n">f_kni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span><span class="p">,</span> <span class="n">nbf</span><span class="p">),</span> <span class="n">wfs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">spos_xc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">splines_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spos_c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">locfun</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spos_c</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">spos_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spos_ac</span><span class="p">[</span><span class="n">spos_c</span><span class="p">]</span>
            <span class="n">spos_xc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spos_c</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">.5</span> <span class="o">*</span> <span class="n">Bohr</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
            <span class="n">f_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">fac</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
                   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fac</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">splines_x</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Spline</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">f_g</span><span class="o">=</span><span class="n">f_g</span><span class="p">)])</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="n">LFC</span><span class="p">(</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="p">,</span> <span class="n">splines_x</span><span class="p">,</span> <span class="n">wfs</span><span class="o">.</span><span class="n">kd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wfs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lf</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">spos_xc</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f_ani</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">wfs</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">nbands</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="n">wfs</span><span class="o">.</span><span class="n">kpt_u</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kpt</span><span class="o">.</span><span class="n">s</span> <span class="o">!=</span> <span class="n">spin</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lf</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">kpt</span><span class="o">.</span><span class="n">psit_nG</span><span class="p">[:],</span> <span class="n">f_ani</span><span class="p">,</span> <span class="n">kpt</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">f_ni</span> <span class="ow">in</span> <span class="n">f_ani</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="n">f_ni</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">f_kni</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_ni</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">i2</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">f_kni</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_number_of_grid_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">N_c</span>

    <span class="k">def</span> <span class="nf">get_number_of_iterations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">niter</span>

    <span class="k">def</span> <span class="nf">get_number_of_electrons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">nvalence</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">charge</span>

    <span class="k">def</span> <span class="nf">get_electrostatic_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate PAW correction to average electrostatic potential.&quot;&quot;&quot;</span>
        <span class="n">dEH_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">D_sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">D_asp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">setup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">setups</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="n">dEH_a</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">dEH0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">dEH_p</span><span class="p">,</span> <span class="n">D_sp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfs</span><span class="o">.</span><span class="n">gd</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dEH_a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dEH_a</span> <span class="o">*</span> <span class="n">Ha</span> <span class="o">*</span> <span class="n">Bohr</span><span class="o">**</span><span class="mi">3</span>

    <span class="k">def</span> <span class="nf">get_nonselfconsistent_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;beefvdw&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gpaw.xc.bee</span> <span class="kn">import</span> <span class="n">BEEFEnsemble</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;beefvdw&#39;</span><span class="p">,</span> <span class="s1">&#39;mbeef&#39;</span><span class="p">,</span> <span class="s1">&#39;mbeefvdw&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Not implemented for type = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">converged</span>
        <span class="n">bee</span> <span class="o">=</span> <span class="n">BEEFEnsemble</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">bee</span><span class="o">.</span><span class="n">create_xc_contributions</span><span class="p">(</span><span class="s1">&#39;exch&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">bee</span><span class="o">.</span><span class="n">create_xc_contributions</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;beefvdw&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;mbeef&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;mbeefvdw&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_p</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">rc2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Embed QM region in point-charges.&quot;&quot;&quot;</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">PointChargePotential</span><span class="p">(</span><span class="n">q_p</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">rc2</span><span class="o">=</span><span class="n">rc2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">external</span><span class="o">=</span><span class="n">pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pc</span>

    <span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">soc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">shift_fermi_level</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DOSCalculator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create DOS-calculator.</span>

<span class="sd">        Default is to shift_fermi_level to 0.0 eV.  For soc=True, angles</span>
<span class="sd">        can be given in degrees.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DOSCalculator</span><span class="o">.</span><span class="n">from_calculator</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">soc</span><span class="o">=</span><span class="n">soc</span><span class="p">,</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
            <span class="n">shift_fermi_level</span><span class="o">=</span><span class="n">shift_fermi_level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gs_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Temporary helper to convert response code and related parts</span>
        <span class="c1"># so it does not depend directly on calc.</span>
        <span class="c1">#</span>
        <span class="c1"># This method can be removed once we finish that process.</span>
        <span class="kn">from</span> <span class="nn">gpaw.response.groundstate</span> <span class="kn">import</span> <span class="n">ResponseGroundStateAdapter</span>
        <span class="k">return</span> <span class="n">ResponseGroundStateAdapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># H2-molecule example:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">gpaw</span> <span class="kn">import</span> <span class="n">GPAW</span><span class="p">,</span> <span class="n">PW</span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline"></a></h1>
<dl class="citation">
<dt class="label" id="liechtenstein"><span class="brackets">Liechtenstein</span></dt>
<dd><p>A. I. Liechtenstein, V. I. Anisimov and J. Zaane,
Phys. Rev. B 52, R5467 (1995).</p>
</dd>
<dt class="label" id="dudarev"><span class="brackets">Dudarev</span></dt>
<dd><p>S. L. Dudarev, G. A. Botton, S. Y. Savrasov, C. J. Humphreys
and A. P. Sutton, Phys. Rev. B 57, 1505 (1998).</p>
</dd>
</dl>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="litesoph/litesoph.visualization.html" class="btn btn-neutral float-left" title="litesoph.visualization package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, LITESOPH members and team.
      <span class="lastupdated">Last updated on Fri, 11 Nov 2022 10:54:25.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>